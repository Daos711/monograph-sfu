% =============================================================
% preamble.tex — Преамбула монографии (СТУ 7.5–07–2021 СФУ)
% =============================================================

% --- Язык и шрифты ---
\usepackage[utf8]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage[russian]{babel}
\usepackage{tempora}

% --- Геометрия страницы (СТУ: 30/10/20/20 мм) ---
\usepackage{geometry}
\geometry{
  left=30mm, right=10mm,
  top=20mm, bottom=20mm,
  nohead,
  includefoot
}

\raggedbottom

% --- Интервалы, абзац ---
\usepackage{setspace}
\singlespacing

\usepackage{indentfirst}
\setlength{\parindent}{1.25cm}
\setlength{\parskip}{0pt}

\tolerance=1000
\hbadness=1000
\emergencystretch=1.5em

% --- Математика ---
\usepackage[fleqn]{amsmath}
\usepackage{amssymb,amsthm}
\usepackage{mathtools}

\setlength{\mathindent}{1.25cm}

% --- Формулы: автоматические отступы по СТУ ---
\makeatletter
\AtBeginDocument{%
  \setlength{\abovedisplayskip}{\baselineskip}
  \setlength{\abovedisplayshortskip}{\baselineskip}
  \setlength{\belowdisplayskip}{\baselineskip}
  \setlength{\belowdisplayshortskip}{\baselineskip}

  % Формула в начале страницы: БЕЗ отступа сверху
  \everydisplay\expandafter{%
    \the\everydisplay
    \ifdim\pagetotal<1pt\relax
      \abovedisplayskip=0pt\relax
      \abovedisplayshortskip=0pt\relax
    \fi
  }%
}
\makeatother

% --- Перечисления ---
\usepackage{enumitem}
\setlist[itemize]{
  label={-},
  leftmargin=0pt,
  itemindent=\dimexpr\parindent+\labelsep+0.5em\relax,
  labelsep=0.5em,
  listparindent=0pt,
  topsep=0pt,
  partopsep=0pt,
  parsep=0pt,
  itemsep=2pt,
}

% --- Графика ---
\usepackage{graphicx}
\graphicspath{{figures/}}
\usepackage{tikz}
\usetikzlibrary{arrows.meta,calc,patterns}

% --- Таблицы ---
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{array}

% --- Подписи ---
\usepackage{caption}
\captionsetup{labelsep=endash, font={normalsize}}
\captionsetup[figure]{name=Рисунок, position=bottom, justification=centering}
\captionsetup[table]{name=Таблица, position=top, justification=raggedright, singlelinecheck=false, margin=0pt}

% --- Нумерация по главам ---
\usepackage{chngcntr}
\counterwithin{equation}{chapter}
\counterwithin{figure}{chapter}
\counterwithin{table}{chapter}

% --- Содержание ---
\usepackage[titles]{tocloft}
\renewcommand{\contentsname}{СОДЕРЖАНИЕ}

\setlength{\cftbeforetoctitleskip}{0pt}
\setlength{\cftaftertoctitleskip}{\baselineskip}

\setlength{\cftchapindent}{0pt}
\setlength{\cftsecindent}{5mm}
\setlength{\cftsubsecindent}{10mm}

\renewcommand{\cftchapleader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cftsubsecleader}{\cftdotfill{\cftdotsep}}

\renewcommand{\cftchapfont}{}
\renewcommand{\cftchappagefont}{}
\renewcommand{\cftsecfont}{}
\renewcommand{\cftsecpagefont}{}
\renewcommand{\cftsubsecfont}{}
\renewcommand{\cftsubsecpagefont}{}

% --- Заголовки ---
\usepackage{titlesec}

\renewcommand{\chaptername}{}
\renewcommand{\thechapter}{\arabic{chapter}}

\titleformat{\chapter}[block]
  {\normalfont\normalsize\bfseries}
  {\thechapter}{0.5em}{}
\titlespacing*{\chapter}{\parindent}{0pt}{\baselineskip}

\titleformat{name=\chapter,numberless}[block]
  {\normalfont\normalsize\bfseries\centering}
  {}{0pt}{\MakeUppercase}
\titlespacing*{name=\chapter,numberless}{0pt}{0pt}{\baselineskip}

\titleformat{\section}[block]
  {\normalfont\normalsize\bfseries}
  {\thesection}{0.5em}{}
\titlespacing*{\section}{\parindent}{\baselineskip}{\baselineskip}

\titleformat{\subsection}[block]
  {\normalfont\normalsize\bfseries}
  {\thesubsection}{0.5em}{}
\titlespacing*{\subsection}{\parindent}{\baselineskip}{\baselineskip}

% --- Библиография ---
\usepackage[numbers,sort&compress]{natbib}
\addto\captionsrussian{%
  \renewcommand{\bibname}{СПИСОК ИСПОЛЬЗОВАННЫХ ИСТОЧНИКОВ}%
}

% --- Гиперссылки ---
\usepackage[hidelinks]{hyperref}

% --- Нумерация страниц ---
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyfoot[C]{\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

\fancypagestyle{plain}{%
  \fancyhf{}%
  \fancyfoot[C]{\thepage}%
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%
}

% --- Float-страницы ---
\makeatletter
\setlength{\@fptop}{0pt}
\setlength{\@fpsep}{\baselineskip}
\setlength{\@fpbot}{0pt}
\makeatother
